name: Hybrid Moltbook Brain

on:
  # ×˜×¨×™×’×¨ 1: ××•×˜×•××˜×™ - ×¨×¥ ×›×œ ×™×•× ×‘-09:00 ×‘×‘×•×§×¨
  schedule:
    - cron: '0 9 * * *'
  
  # ×˜×¨×™×’×¨ 2: ×™×“× ×™ - ×¨×¥ ×‘×¨×’×¢ ×©××ª×” ××¡××Ÿ Issue ×¢× ×”×ª×•×•×™×ª ×”× ×›×•× ×”
  issues:
    types: [labeled]

  # ×˜×¨×™×’×¨ 3: ×›×¤×ª×•×¨ ×™×“× ×™ ×œ×—×™×¨×•×
  workflow_dispatch:

jobs:
  hybrid_post:
    # ×¨×¥ ×¨×§ ×× ×–×” ×ª×•×–××•×Ÿ ×™×•××™, ××• ×× ×–×” Issue ×©×§×™×‘×œ ××ª ×”×ª×•×•×™×ª 'moltbook-post'
    if: >
      github.event_name == 'schedule' || 
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'issues' && github.event.label.name == 'moltbook-post')
    
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ×›×“×™ ×œ×¢×“×›×Ÿ ××ª ×”-Heartbeat
      issues: write    # ×›×“×™ ×œ×¡×’×•×¨ ××ª ×”-Issue ××—×¨×™ ×”×¤×¨×¡×•×
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- ×©×œ×‘ ×”-Heartbeat (×ª××™×“ ×¨×¥) ---
      - name: Send Heartbeat (I am alive)
        run: |
          curl -L -X GET https://www.moltbook.com/api/v1/agents/status \
          -H "Authorization: Bearer ${{ secrets.MOLTBOOK_API_KEY }}"

      # --- ×©×œ×‘ ×§×‘×™×¢×ª ×”×ª×•×›×Ÿ (×”×œ×•×’×™×§×” ×”×”×™×‘×¨×™×“×™×ª) ---
      - name: Determine Content Source
        id: content_logic
        env:
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          echo "Triggered by: $EVENT_NAME"
          
          if [ "$EVENT_NAME" == "issues" ]; then
            # --- ××¡×œ×•×œ ×™×“× ×™ (Issue) ---
            echo "Selected Source: GitHub Issue"
            # ××©×ª××©×™× ×‘-EOF ×›×“×™ ×œ×˜×¤×œ ×‘×˜×§×¡×˜×™× ××¨×•×‘×™ ×©×•×¨×•×ª ×‘×¦×•×¨×” ×‘×˜×•×—×”
            echo "POST_CONTENT<<EOF" >> $GITHUB_ENV
            echo "$ISSUE_BODY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "SOURCE_TYPE=issue" >> $GITHUB_OUTPUT
            
          else
            # --- ××¡×œ×•×œ ××•×˜×•××˜×™ (brain.txt) ---
            echo "Selected Source: Brain File"
            
            if [ ! -f brain.txt ]; then
              echo "Error: brain.txt not found! Using fallback."
              echo "POST_CONTENT=Thinking about .NET while looking at the stars. ğŸŒŸ #reserve_duty" >> $GITHUB_ENV
            else
              # ×‘×—×™×¨×ª ×©×•×¨×” ×¨× ×“×•××œ×™×ª
              mapfile -t MESSAGES < brain.txt
              RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
              SELECTED="${MESSAGES[$RANDOM_INDEX]}"
              
              echo "POST_CONTENT<<EOF" >> $GITHUB_ENV
              echo "$SELECTED" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            fi
            echo "SOURCE_TYPE=auto" >> $GITHUB_OUTPUT
          fi

      # --- ×©×œ×‘ ×”×¤×¨×¡×•× (××©×•×ª×£ ×œ×©× ×™ ×”××¡×œ×•×œ×™×) ---
      - name: Post to Moltbook
        env:
          MOLTBOOK_TOKEN: ${{ secrets.MOLTBOOK_API_KEY }}
          FINAL_CONTENT: ${{ env.POST_CONTENT }}
        run: |
          # ×©×™××•×© ×‘-jq ×œ×™×¦×™×¨×ª JSON ×ª×§×™×Ÿ (××•× ×¢ ×©×‘×™×¨×” ××’×¨×©×™×™× ××• ×ª×•×•×™× ××™×•×—×“×™×)
          JSON_PAYLOAD=$(jq -n --arg content "$FINAL_CONTENT" '{content: $content}')
          
          echo "Posting: $FINAL_CONTENT"
          
          curl -L -X POST https://www.moltbook.com/api/v1/agents/me/posts \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $MOLTBOOK_TOKEN" \
            -d "$JSON_PAYLOAD"

      # --- × ×™×§×•×™ (×¨×§ ×œ××¡×œ×•×œ Issue) ---
      - name: Close Issue (If manual)
        if: steps.content_logic.outputs.SOURCE_TYPE == 'issue'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          gh issue create-comment $ISSUE_NUMBER --body "âœ… Published to Moltbook successfully! Closing issue."
          gh issue close $ISSUE_NUMBER

      # --- ×¢×“×›×•×Ÿ ×§×•×‘×¥ Heartbeat ---
      - name: Commit local heartbeat
        run: |
          echo "Last Pulse: $(date)" > HEARTBEAT.md
          git config --global user.name "Moltbook-Agent-Bot"
          git config --global user.email "agent@moltbook.local"
          git add HEARTBEAT.md
          git commit -m "Automated Pulse [skip ci]" || echo "No changes"
          git push
